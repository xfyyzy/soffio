{% extends "admin/layouts/panel.html" %}

{% block panel_id %}api-keys{% endblock %}
{% block panel_heading %}API keys{% endblock %}

{% block panel_toolbar %}
      <a href="{{ content.new_key_href }}">New API key</a>
{% endblock panel_toolbar %}

{% block panel_controls %}
{% let panel_action = content.panel_action %}
{% include "admin/partials/status_tabs.html" %}
{% include "admin/partials/filter_form.html" %}
{% endblock panel_controls %}

{% block panel_content %}
  <table data-role="publishable-table">
    <thead>
      <tr>
        <th scope="col">Name</th>
        <th scope="col">Prefix</th>
        <th scope="col">Scopes</th>
        <th scope="col">Created</th>
        <th scope="col">Last used</th>
        <th scope="col">Status</th>
        <th scope="col">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for key in content.keys %}
      <tr data-role="api-key-row" data-key-id="{{ key.id }}">
        <td>{{ key.name }}</td>
        <td><code>{{ key.prefix }}</code></td>
        <td>
          <div data-role="badge-row">
          {% for scope in key.scopes %}
            <span data-role="badge">{{ scope }}</span>
          {% endfor %}
          </div>
        </td>
        <td>{{ key.created_at }}</td>
        <td>
          {% if let Some(ts) = key.last_used_at %}
            {{ ts }}
          {% else %}
            <span data-role="muted">â€”</span>
          {% endif %}
        </td>
        <td>
          {% if key.revoked %}
            <span data-role="badge" data-variant="danger">revoked</span>
          {% else %}
            <span data-role="badge" data-variant="success">active</span>
          {% endif %}
        </td>
        <td data-role="publishable-actions">
          <form data-role="inline-form" method="post" action="{{ key.rotate_action }}"
                data-on-submit__prevent="(@post(`{{ key.rotate_action }}`, { contentType: 'form' }))">
            <input type="hidden" name="cursor" value="{% if let Some(v) = &content.cursor_param %}{{ v }}{% endif %}">
            <input type="hidden" name="status" value="{% if let Some(v) = &content.active_status_key %}{{ v }}{% endif %}">
            <input type="hidden" name="search" value="{% if let Some(v) = &content.filter_search %}{{ v }}{% endif %}">
            <input type="hidden" name="scope" value="{% if let Some(v) = &content.filter_scope %}{{ v }}{% endif %}">
            <button type="submit">Rotate</button>
          </form>
          <form data-role="inline-form" method="post" action="{{ key.revoke_action }}"
                data-on-submit__prevent="(@post(`{{ key.revoke_action }}`, { contentType: 'form' }))">
            <input type="hidden" name="cursor" value="{% if let Some(v) = &content.cursor_param %}{{ v }}{% endif %}">
            <input type="hidden" name="status" value="{% if let Some(v) = &content.active_status_key %}{{ v }}{% endif %}">
            <input type="hidden" name="search" value="{% if let Some(v) = &content.filter_search %}{{ v }}{% endif %}">
            <input type="hidden" name="scope" value="{% if let Some(v) = &content.filter_scope %}{{ v }}{% endif %}">
            <button type="submit" data-variant="danger">Revoke</button>
          </form>
        </td>
      </tr>
      {% endfor %}
      {% if !content.has_keys %}
      <tr><td colspan="7">No API keys yet.</td></tr>
      {% endif %}
    </tbody>
  </table>
{% include "admin/partials/pagination.html" %}
{% endblock panel_content %}
