{% extends "admin/shell.html" %}

{% block content %}
<section data-role="panel">
  <header data-role="panel-header">
    <h2 data-role="panel-title">{{ view.content.heading }}</h2>
  </header>
  <div data-role="panel-body">
    {% match view.content.flash %}
    {% when Some(flash) %}
    <div data-role="flash" data-flash-kind="{{ flash.kind }}">{{ flash.text }}</div>
    {% when None %}{% endmatch %}

    <form data-role="filter-form" method="get">
      <label>
        <span>State</span>
        <select name="state">
          {% for option in view.content.state_options %}
          <option value="{{ option.value }}" {% if option.selected %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        <span>Type</span>
        <select name="job_type">
          {% for option in view.content.type_options %}
          <option value="{{ option.value }}" {% if option.selected %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        <span>Search</span>
        <input type="text" name="search" value="{% if let Some(value) = &view.content.filter_search %}{{ value }}{% endif %}">
      </label>
      <div data-role="filter-actions">
        <button type="submit">Apply Filters</button>
        {% if view.content.filter_state.is_some() || view.content.filter_job_type.is_some() || view.content.filter_search.is_some() %}
        <a href="/jobs" data-role="secondary">Clear</a>
        {% endif %}
      </div>
    </form>

    <table data-role="jobs-table">
      <thead>
        <tr>
          <th scope="col">Job Type</th>
          <th scope="col">Status</th>
          <th scope="col">Scheduled</th>
          <th scope="col">Created</th>
          <th scope="col">Error</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for job in view.content.jobs %}
        <tr data-role="job-row" data-job-id="{{ job.id }}">
          <td>{{ job.job_type }}</td>
          <td>{{ job.status }}</td>
          <td>{% if let Some(time) = job.scheduled_at %}{{ time }}{% else %}<span data-role="muted">—</span>{% endif %}</td>
          <td>{{ job.created_at }}</td>
          <td>{% if let Some(error) = job.error_text %}{{ error }}{% else %}<span data-role="muted">—</span>{% endif %}</td>
          <td data-role="job-actions">
            <a href="{{ job.detail_href }}" data-role="secondary">View</a>
            {% if job.can_retry %}
            <form method="post" action="{{ job.retry_action }}" data-role="inline-form">
              <input type="hidden" name="state" value="{% if let Some(value) = &view.content.filter_state %}{{ value }}{% endif %}">
              <input type="hidden" name="job_type" value="{% if let Some(value) = &view.content.filter_job_type %}{{ value }}{% endif %}">
              <input type="hidden" name="search" value="{% if let Some(value) = &view.content.filter_search %}{{ value }}{% endif %}">
              <input type="hidden" name="cursor" value="{% if let Some(value) = &view.content.current_cursor %}{{ value }}{% endif %}">
              <button type="submit" data-role="primary">Retry</button>
            </form>
            {% endif %}
            {% if job.can_cancel %}
            <form method="post" action="{{ job.cancel_action }}" data-role="inline-form">
              <input type="hidden" name="state" value="{% if let Some(value) = &view.content.filter_state %}{{ value }}{% endif %}">
              <input type="hidden" name="job_type" value="{% if let Some(value) = &view.content.filter_job_type %}{{ value }}{% endif %}">
              <input type="hidden" name="search" value="{% if let Some(value) = &view.content.filter_search %}{{ value }}{% endif %}">
              <input type="hidden" name="cursor" value="{% if let Some(value) = &view.content.current_cursor %}{{ value }}{% endif %}">
              <button type="submit" data-role="danger">Cancel</button>
            </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if let Some(cursor) = &view.content.next_cursor %}
    <nav data-role="pagination">
      <a data-role="next" href="/jobs?cursor={{ cursor }}{% if !view.content.filter_query.is_empty() %}&{{ view.content.filter_query }}{% endif %}">Next</a>
    </nav>
    {% endif %}
  </div>
</section>
{% endblock %}
