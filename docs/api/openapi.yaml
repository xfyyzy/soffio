openapi: 3.1.0
info:
  title: Soffio Headless Admin API
  version: "0.1.0"
  description: |
    Authenticated JSON API for managing Soffio content. All endpoints require
    a Bearer token that carries an API key issued from the admin UI. Scopes
    are enforced server-side (see descriptions for required scope).
  license:
    name: BSD-2-Clause
    url: https://opensource.org/licenses/BSD-2-Clause
servers:
  - url: http://127.0.0.1:3000
security:
  - ApiKeyAuth: []
components:
  securitySchemes:
    ApiKeyAuth:
      type: http
      scheme: bearer
      bearerFormat: API key (sk_prefix_secret)
  schemas:
    CursorPagePost:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Post'
        next_cursor:
          type: string
      required: [items]
    CursorPagePage:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Page'
        next_cursor:
          type: string
      required: [items]
    CursorPageTag:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Tag'
        next_cursor:
          type: string
      required: [items]
    CursorPageNavigationItem:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/NavigationItem'
        next_cursor:
          type: string
      required: [items]
    CursorPageUpload:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Upload'
        next_cursor:
          type: string
      required: [items]
    CursorPageJob:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Job'
        next_cursor:
          type: string
      required: [items]
    CursorPageAudit:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/AuditEntry'
        next_cursor:
          type: string
      required: [items]
    Post:
      type: object
      properties:
        id: { type: string, format: uuid }
        slug: { type: string }
        title: { type: string }
        excerpt: { type: string }
        body_markdown: { type: string }
        summary_markdown: { type: string }
        summary_html: { type: string }
        status: { $ref: '#/components/schemas/PostStatus' }
        pinned: { type: boolean }
        scheduled_at: { type: string, format: date-time }
        published_at: { type: string, format: date-time }
        archived_at: { type: string, format: date-time }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
      required:
        [id, slug, title, excerpt, body_markdown, status, pinned, created_at, updated_at]
    Page:
      type: object
      properties:
        id: { type: string, format: uuid }
        slug: { type: string }
        title: { type: string }
        body_markdown: { type: string }
        rendered_html: { type: string }
        status: { $ref: '#/components/schemas/PageStatus' }
        scheduled_at: { type: string, format: date-time }
        published_at: { type: string, format: date-time }
        archived_at: { type: string, format: date-time }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
      required:
        [id, slug, title, body_markdown, rendered_html, status, created_at, updated_at]
    Tag:
      type: object
      properties:
        id: { type: string, format: uuid }
        slug: { type: string }
        name: { type: string }
        description: { type: string }
        pinned: { type: boolean }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
      required: [id, slug, name, pinned, created_at, updated_at]
    NavigationItem:
      type: object
      properties:
        id: { type: string, format: uuid }
        label: { type: string }
        destination_type: { $ref: '#/components/schemas/NavigationDestinationType' }
        destination_page_id: { type: string, format: uuid }
        destination_page_slug: { type: string }
        destination_url: { type: string }
        sort_order: { type: integer }
        visible: { type: boolean }
        open_in_new_tab: { type: boolean }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
      required:
        [id, label, destination_type, sort_order, visible, open_in_new_tab, created_at, updated_at]
    Upload:
      type: object
      properties:
        id: { type: string, format: uuid }
        filename: { type: string }
        content_type: { type: string }
        size_bytes: { type: integer }
        checksum: { type: string }
        stored_path: { type: string }
        metadata: { type: object }
        created_at: { type: string, format: date-time }
      required: [id, filename, content_type, size_bytes, checksum, stored_path, created_at]
    SiteSettings:
      type: object
      properties:
        homepage_size: { type: integer }
        admin_page_size: { type: integer }
        show_tag_aggregations: { type: boolean }
        show_month_aggregations: { type: boolean }
        tag_filter_limit: { type: integer }
        month_filter_limit: { type: integer }
        global_toc_enabled: { type: boolean }
        brand_title: { type: string }
        brand_href: { type: string }
        footer_copy: { type: string }
        public_site_url: { type: string }
        favicon_svg: { type: string }
        timezone: { type: string }
        meta_title: { type: string }
        meta_description: { type: string }
        og_title: { type: string }
        og_description: { type: string }
        updated_at: { type: string, format: date-time }
      required:
        [homepage_size, admin_page_size, show_tag_aggregations, show_month_aggregations,
         tag_filter_limit, month_filter_limit, global_toc_enabled, brand_title, brand_href,
         footer_copy, public_site_url, timezone, meta_title, meta_description, og_title,
         og_description, updated_at]
    Job:
      type: object
      properties:
        id: { type: string }
        job_type: { $ref: '#/components/schemas/JobType' }
        payload: { type: object }
        state: { $ref: '#/components/schemas/JobState' }
        attempts: { type: integer }
        max_attempts: { type: integer }
        run_at: { type: string, format: date-time }
        lock_at: { type: string, format: date-time }
        lock_by: { type: string }
        done_at: { type: string, format: date-time }
        last_error: { type: string }
        priority: { type: integer }
      required:
        [id, job_type, payload, state, attempts, max_attempts, run_at, priority]
    AuditEntry:
      type: object
      properties:
        id: { type: string, format: uuid }
        actor: { type: string }
        action: { type: string }
        entity_type: { type: string }
        entity_id: { type: string }
        payload_text: { type: string }
        created_at: { type: string, format: date-time }
      required: [id, actor, action, entity_type, created_at]
    Error:
      type: object
      properties:
        code: { type: string }
        message: { type: string }
        hint: { type: string }
      required: [code, message]
    PostStatus:
      type: string
      enum: [draft, published, archived, error]
    PageStatus:
      type: string
      enum: [draft, published, archived, error]
    NavigationDestinationType:
      type: string
      enum: [internal, external]
    JobState:
      type: string
      enum: [pending, scheduled, running, done, failed, killed]
    JobType:
      type: string
      enum: [render_post, render_post_sections, render_post_section, render_page, render_summary,
             publish_post, publish_page, invalidate_cache]
    PostCreateRequest:
      type: object
      required: [title, excerpt, body_markdown]
      properties:
        title: { type: string }
        excerpt: { type: string }
        body_markdown: { type: string }
        summary_markdown: { type: string }
        status: { $ref: '#/components/schemas/PostStatus' }
        pinned: { type: boolean, default: false }
        scheduled_at: { type: string, format: date-time }
        published_at: { type: string, format: date-time }
        archived_at: { type: string, format: date-time }
    PostUpdateRequest:
      type: object
      required: [slug, title, excerpt, body_markdown]
      properties:
        slug: { type: string }
        title: { type: string }
        excerpt: { type: string }
        body_markdown: { type: string }
        summary_markdown: { type: string }
        pinned: { type: boolean, default: false }
    PostStatusRequest:
      type: object
      required: [status]
      properties:
        status: { $ref: '#/components/schemas/PostStatus' }
        scheduled_at: { type: string, format: date-time }
        published_at: { type: string, format: date-time }
        archived_at: { type: string, format: date-time }
    PostTagsRequest:
      type: object
      required: [tag_ids]
      properties:
        tag_ids:
          type: array
          items: { type: string, format: uuid }
    PageCreateRequest:
      type: object
      required: [title, body_markdown]
      properties:
        slug: { type: string }
        title: { type: string }
        body_markdown: { type: string }
        status: { $ref: '#/components/schemas/PageStatus' }
        scheduled_at: { type: string, format: date-time }
        published_at: { type: string, format: date-time }
        archived_at: { type: string, format: date-time }
    PageUpdateRequest:
      type: object
      required: [slug, title, body_markdown]
      properties:
        slug: { type: string }
        title: { type: string }
        body_markdown: { type: string }
    PageStatusRequest:
      type: object
      required: [status]
      properties:
        status: { $ref: '#/components/schemas/PageStatus' }
        scheduled_at: { type: string, format: date-time }
        published_at: { type: string, format: date-time }
        archived_at: { type: string, format: date-time }
    TagCreateRequest:
      type: object
      required: [name]
      properties:
        name: { type: string }
        description: { type: string }
        pinned: { type: boolean, default: false }
    TagUpdateRequest:
      type: object
      required: [name]
      properties:
        name: { type: string }
        description: { type: string }
        pinned: { type: boolean, default: false }
    NavigationCreateRequest:
      type: object
      required: [label, destination_type, sort_order]
      properties:
        label: { type: string }
        destination_type: { $ref: '#/components/schemas/NavigationDestinationType' }
        destination_page_id: { type: string, format: uuid }
        destination_url: { type: string }
        sort_order: { type: integer }
        visible: { type: boolean, default: false }
        open_in_new_tab: { type: boolean, default: false }
    NavigationUpdateRequest:
      type: object
      required: [label, destination_type, sort_order]
      properties:
        label: { type: string }
        destination_type: { $ref: '#/components/schemas/NavigationDestinationType' }
        destination_page_id: { type: string, format: uuid }
        destination_url: { type: string }
        sort_order: { type: integer }
        visible: { type: boolean, default: false }
        open_in_new_tab: { type: boolean, default: false }
    SettingsPatchRequest:
      type: object
      properties:
        brand_title: { type: string }
        brand_href: { type: string }
        footer_copy: { type: string }
        homepage_size: { type: integer }
        admin_page_size: { type: integer }
        show_tag_aggregations: { type: boolean }
        show_month_aggregations: { type: boolean }
        tag_filter_limit: { type: integer }
        month_filter_limit: { type: integer }
        timezone: { type: string }
        meta_title: { type: string }
        meta_description: { type: string }
        og_title: { type: string }
        og_description: { type: string }
        public_site_url: { type: string }
paths:
  /api/v1/posts:
    get:
      summary: List posts
      description: Requires scope `post_read`.
      parameters:
        - in: query
          name: status
          schema: { $ref: '#/components/schemas/PostStatus' }
        - in: query
          name: search
          schema: { type: string }
        - in: query
          name: tag
          schema: { type: string }
        - in: query
          name: month
          schema: { type: string }
        - in: query
          name: cursor
          schema: { type: string }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100 }
      responses:
        '200':
          description: Paginated posts
          content:
            application/json:
              schema: { $ref: '#/components/schemas/CursorPagePost' }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
    post:
      summary: Create post
      description: Requires scope `post_write`.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PostCreateRequest' }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Post' }
        '400': { description: Bad request }
        '401': { description: Unauthorized }
        '403': { description: Forbidden }
  /api/v1/posts/{id}:
    patch:
      summary: Update post
      description: Requires scope `post_write`.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PostUpdateRequest' }
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Post' }
        '404': { description: Not found }
    delete:
      summary: Delete post
      description: Requires scope `post_write`.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '204': { description: Deleted }
        '404': { description: Not found }
  /api/v1/posts/{id}/status:
    post:
      summary: Update post status
      description: Requires scope `post_write`.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PostStatusRequest' }
      responses:
        '200': { description: Status updated }
  /api/v1/posts/{id}/tags:
    post:
      summary: Replace post tags
      description: Requires scope `post_write`.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PostTagsRequest' }
      responses:
        '204': { description: Tags replaced }
  /api/v1/posts/slug/{slug}:
    get:
      summary: Get post by slug
      description: Requires scope `post_read`.
      parameters:
        - in: path
          name: slug
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Post
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Post' }
        '404': { description: Not found }
  /api/v1/pages:
    get:
      summary: List pages
      description: Requires scope `page_read`.
      parameters:
        - in: query
          name: status
          schema: { $ref: '#/components/schemas/PageStatus' }
        - in: query
          name: search
          schema: { type: string }
        - in: query
          name: month
          schema: { type: string }
        - in: query
          name: cursor
          schema: { type: string }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100 }
      responses:
        '200':
          description: Paginated pages
          content:
            application/json:
              schema: { $ref: '#/components/schemas/CursorPagePage' }
    post:
      summary: Create page
      description: Requires scope `page_write`.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PageCreateRequest' }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Page' }
  /api/v1/pages/{id}:
    patch:
      summary: Update page
      description: Requires scope `page_write`.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PageUpdateRequest' }
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Page' }
    delete:
      summary: Delete page
      description: Requires scope `page_write`.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '204': { description: Deleted }
  /api/v1/pages/{id}/status:
    post:
      summary: Update page status
      description: Requires scope `page_write`.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PageStatusRequest' }
      responses:
        '200': { description: Status updated }
  /api/v1/pages/slug/{slug}:
    get:
      summary: Get page by slug
      description: Requires scope `page_read`.
      parameters:
        - in: path
          name: slug
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Page
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Page' }
        '404': { description: Not found }
  /api/v1/tags:
    get:
      summary: List tags
      description: Requires scope `tag_read`.
      parameters:
        - in: query
          name: search
          schema: { type: string }
        - in: query
          name: month
          schema: { type: string }
        - in: query
          name: cursor
          schema: { type: string }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100 }
        - in: query
          name: pinned
          schema: { type: boolean }
      responses:
        '200':
          description: Paginated tags
          content:
            application/json:
              schema: { $ref: '#/components/schemas/CursorPageTag' }
    post:
      summary: Create tag
      description: Requires scope `tag_write`.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TagCreateRequest' }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Tag' }
  /api/v1/tags/{id}:
    patch:
      summary: Update tag
      description: Requires scope `tag_write`.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TagUpdateRequest' }
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Tag' }
    delete:
      summary: Delete tag
      description: Requires scope `tag_write`.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '204': { description: Deleted }
  /api/v1/navigation:
    get:
      summary: List navigation items
      description: Requires scope `navigation_read`.
      parameters:
        - in: query
          name: search
          schema: { type: string }
        - in: query
          name: visible
          schema: { type: boolean }
        - in: query
          name: cursor
          schema: { type: string }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100 }
      responses:
        '200':
          description: Paginated navigation items
          content:
            application/json:
              schema: { $ref: '#/components/schemas/CursorPageNavigationItem' }
    post:
      summary: Create navigation item
      description: Requires scope `navigation_write`.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/NavigationCreateRequest' }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NavigationItem' }
  /api/v1/navigation/{id}:
    patch:
      summary: Update navigation item
      description: Requires scope `navigation_write`.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/NavigationUpdateRequest' }
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NavigationItem' }
    delete:
      summary: Delete navigation item
      description: Requires scope `navigation_write`.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '204': { description: Deleted }
  /api/v1/uploads:
    get:
      summary: List uploads
      description: Requires scope `upload_read`.
      parameters:
        - in: query
          name: search
          schema: { type: string }
        - in: query
          name: content_type
          schema: { type: string }
        - in: query
          name: month
          schema: { type: string }
        - in: query
          name: cursor
          schema: { type: string }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100 }
      responses:
        '200':
          description: Paginated uploads
          content:
            application/json:
              schema: { $ref: '#/components/schemas/CursorPageUpload' }
    post:
      summary: Upload file
      description: Requires scope `upload_write`. Multipart form with `file` field.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '201':
          description: Uploaded
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Upload' }
  /api/v1/uploads/{id}:
    delete:
      summary: Delete upload
      description: Requires scope `upload_write`.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      responses:
        '204': { description: Deleted }
  /api/v1/site/settings:
    get:
      summary: Get site settings
      description: Requires scope `settings_read`.
      responses:
        '200':
          description: Settings
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SiteSettings' }
    patch:
      summary: Patch site settings
      description: Requires scope `settings_write`.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SettingsPatchRequest' }
      responses:
        '200':
          description: Updated settings
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SiteSettings' }
  /api/v1/jobs:
    get:
      summary: List jobs
      description: Requires scope `job_read`.
      parameters:
        - in: query
          name: state
          schema: { $ref: '#/components/schemas/JobState' }
        - in: query
          name: job_type
          schema: { $ref: '#/components/schemas/JobType' }
        - in: query
          name: search
          schema: { type: string }
        - in: query
          name: cursor
          schema: { type: string }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100 }
      responses:
        '200':
          description: Paginated jobs
          content:
            application/json:
              schema: { $ref: '#/components/schemas/CursorPageJob' }
  /api/v1/audit:
    get:
      summary: List audit entries
      description: Requires scope `audit_read`.
      parameters:
        - in: query
          name: actor
          schema: { type: string }
        - in: query
          name: action
          schema: { type: string }
        - in: query
          name: entity_type
          schema: { type: string }
        - in: query
          name: search
          schema: { type: string }
        - in: query
          name: cursor
          schema: { type: string }
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100 }
      responses:
        '200':
          description: Paginated audit entries
          content:
            application/json:
              schema: { $ref: '#/components/schemas/CursorPageAudit' }
