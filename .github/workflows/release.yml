name: Release
on:
  push:
    tags: ["v*.*.*"]

permissions:
  contents: write
  packages: write

env:
  BIN_NAME: soffio
  BIN_CLI: soffio-cli
  MERMAID_CLI_IMAGE: minlag/mermaid-cli:latest
  RELEASE_TAG: ${{ github.ref_name }}
  RELEASE_BUILDER_IMAGE: ghcr.io/${{ github.repository }}/soffio-release-build:latest

jobs:
  build-binaries:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cpu_level: [x86-64-v2, x86-64-v3, x86-64-v4]
    steps:
      - uses: actions/checkout@v6
      - name: Login to GHCR (for builder image)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull release builder image
        run: docker pull "$RELEASE_BUILDER_IMAGE"
      - name: Prepare cache directories
        run: |
          mkdir -p ~/.cargo/registry ~/.cargo/git ~/.npm
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ matrix.cpu_level }}
      - name: Build (Alpine musl)
        env:
          CPU_LEVEL: ${{ matrix.cpu_level }}
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_RUSTFLAGS: -C target-cpu=${{ matrix.cpu_level }}
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/work" \
            -v "$HOME/.cargo:/root/.cargo" \
            -v "$HOME/.npm:/root/.npm" \
            -e BIN_NAME="${BIN_NAME}" \
            -e BIN_CLI="${BIN_CLI}" \
            -e CPU_LEVEL="${CPU_LEVEL}" \
            -e CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_RUSTFLAGS="${CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_RUSTFLAGS}" \
            -e RELEASE_TAG="${RELEASE_TAG}" \
            -w /work \
            "$RELEASE_BUILDER_IMAGE" \
            sh -ec '
              set -eux
              cargo build --release --target x86_64-unknown-linux-musl --bin ${BIN_NAME} --bin ${BIN_CLI} && \
              rm -rf dist && mkdir -p dist && \
              cp target/x86_64-unknown-linux-musl/release/${BIN_NAME} dist/${BIN_NAME} && \
              cp target/x86_64-unknown-linux-musl/release/${BIN_CLI} dist/${BIN_CLI} && \
              strip dist/${BIN_NAME} dist/${BIN_CLI} || true && \
              tar_name="${BIN_NAME}-${RELEASE_TAG}-${CPU_LEVEL}-musl.tar.gz" && \
              tar czf "${tar_name}" -C dist ${BIN_NAME} ${BIN_CLI} && \
              # fix permissions before cache save on host
              HOST_UID=$(stat -c '%u' /work) && HOST_GID=$(stat -c '%g' /work) && \
              chown -R "$HOST_UID:$HOST_GID" /work/target /root/.cargo /root/.npm || true
            '
      - name: Upload artifacts
        uses: actions/upload-artifact@v5
        with:
          name: ${{ env.BIN_NAME }}-${{ env.RELEASE_TAG }}-${{ matrix.cpu_level }}-musl
          path: ${{ env.BIN_NAME }}-${{ env.RELEASE_TAG }}-${{ matrix.cpu_level }}-musl.tar.gz
      - uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.BIN_NAME }}-${{ env.RELEASE_TAG }}-${{ matrix.cpu_level }}-musl.tar.gz
        if: startsWith(github.ref, 'refs/tags/')

  docker:
    runs-on: ubuntu-latest
    needs: build-binaries
    strategy:
      matrix:
        cpu_level: [x86-64-v2, x86-64-v3, x86-64-v4]
    steps:
      - uses: actions/checkout@v6
      - name: Cache prebuilt dir
        uses: actions/cache@v4
        with:
          path: prebuilt/${{ matrix.cpu_level }}
          key: prebuilt-${{ env.RELEASE_TAG }}-${{ matrix.cpu_level }}
      - name: Download prebuilt binaries
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.BIN_NAME }}-${{ env.RELEASE_TAG }}-${{ matrix.cpu_level }}-musl
          path: prebuilt/${{ matrix.cpu_level }}
      - name: Extract prebuilt binaries
        run: |
          tar -xzf prebuilt/${{ matrix.cpu_level }}/${{ env.BIN_NAME }}-${{ env.RELEASE_TAG }}-${{ matrix.cpu_level }}-musl.tar.gz -C prebuilt/${{ matrix.cpu_level }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build & Push (musl)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deploy/docker/Dockerfile
          push: true
          platforms: linux/amd64
          build-args: |
            TARGET_TRIPLE=x86_64-unknown-linux-musl
            TARGET_CPU=${{ matrix.cpu_level }}
            MERMAID_CLI_IMAGE=${{ env.MERMAID_CLI_IMAGE }}
            PREBUILT_DIR=prebuilt/${{ matrix.cpu_level }}
          cache-from: type=gha,scope=${{ github.ref_name }}-${{ matrix.cpu_level }}
          cache-to: type=gha,mode=max,scope=${{ github.ref_name }}-${{ matrix.cpu_level }}
          tags: |
            ghcr.io/${{ github.repository }}:amd64-${{ matrix.cpu_level }}
            ghcr.io/${{ github.repository }}:${{ env.RELEASE_TAG }}-amd64-${{ matrix.cpu_level }}

  publish-release-builder:
    needs: build-binaries
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - name: Build & Push release builder image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deploy/docker/Dockerfile.build
          build-args: |
            INSTALL_REDOC=false
          tags: |
            ghcr.io/${{ github.repository }}/soffio-release-build:latest
            ghcr.io/${{ github.repository }}/soffio-release-build:${{ github.sha }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/soffio-release-build:buildcache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository }}/soffio-release-build:buildcache,mode=max
          push: true
