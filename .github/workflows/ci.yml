name: CI

on:
  push:
  pull_request:
  workflow_dispatch:
permissions:
  contents: read
  packages: write

env:
  CARGO_TERM_COLOR: always
  CI_BUILDER_IMAGE: ghcr.io/${{ github.repository }}/soffio-ci-build:latest

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Login to GHCR (for builder image)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull CI builder image
        run: docker pull "$CI_BUILDER_IMAGE"

      - name: Start Postgres (test DB)
        run: |
          docker run -d --name soffio-pg \
            -e POSTGRES_USER=soffio \
            -e POSTGRES_PASSWORD=soffio_local_dev \
            -e POSTGRES_DB=soffio_dev \
            -p 5432:5432 \
            postgres:18
          until docker exec soffio-pg pg_isready -U soffio -d soffio_dev; do sleep 1; done

      - name: Prepare cache directories
        run: |
          mkdir -p ~/.cargo/registry ~/.cargo/git ~/.npm

      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-default
          cache-on-failure: true

      - name: Lint, Spec Check & Test (Alpine musl)
        env:
          # Override native in config.toml with a safe baseline for target code.
          # build.rs uses host default instruction set (unaffected by this flag).
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_RUSTFLAGS: -C target-cpu=x86-64-v2
        run: |
          docker run --rm \
            --network=host \
            -v "${{ github.workspace }}:/work" \
            -v "$HOME/.cargo:/root/.cargo" \
            -v "$HOME/.npm:/root/.npm" \
            -w /work \
            -e DATABASE_URL=postgres://soffio:soffio_local_dev@127.0.0.1:5432/soffio_dev \
            -e SQLX_TEST_DATABASE_URL=postgres://soffio:soffio_local_dev@127.0.0.1:5432/postgres \
            -e SQLX_OFFLINE=true \
            -e CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_RUSTFLAGS="${CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_RUSTFLAGS}" \
            "$CI_BUILDER_IMAGE" \
            sh -ec '
              set -eux; \
              redocly lint docs/api/openapi.yaml; \
              cargo fmt --all -- --check; \
              cargo check --workspace --all-targets --target x86_64-unknown-linux-musl; \
              cargo clippy --workspace --all-targets --target x86_64-unknown-linux-musl -- -D warnings; \
              cargo run --target x86_64-unknown-linux-musl --bin gen_cli_docs; \
              # Ensure docs are regenerated and committed. Explicit GIT_DIR/WORK_TREE avoids absolute-path issues when mounted at /work. \
              if ! GIT_DIR=/work/.git GIT_WORK_TREE=/work git diff --quiet HEAD -- docs/cli.md docs/cli.zh.md; then \
                echo "cli docs out of date; run cargo run --bin gen_cli_docs and commit." >&2; \
                GIT_DIR=/work/.git GIT_WORK_TREE=/work git diff --stat HEAD -- docs/cli.md docs/cli.zh.md; \
                GIT_DIR=/work/.git GIT_WORK_TREE=/work git diff HEAD -- docs/cli.md docs/cli.zh.md; \
                exit 1; \
              fi; \
              cargo nextest run --workspace --all-targets --target x86_64-unknown-linux-musl --profile ci --no-fail-fast; \
              cargo run --target x86_64-unknown-linux-musl --bin soffio -- import --database-url postgres://soffio:soffio_local_dev@127.0.0.1:5432/soffio_dev seed/seed.toml; \
              LOG_PATH=/tmp/soffio.log; \
              cp soffio.toml.example /tmp/soffio.toml; \
              cargo run --target x86_64-unknown-linux-musl --bin soffio -- --config-file /tmp/soffio.toml serve \
                --server-host 0.0.0.0 \
                --server-admin-host 0.0.0.0 \
                --server-public-port 3000 \
                --server-admin-port 3001 \
                >"$LOG_PATH" 2>&1 & \
              srv=$!; \
              ready=0; \
              for i in $(seq 1 60); do \
                if curl -sf http://127.0.0.1:3000/_health/db >/dev/null; then ready=1; break; fi; \
                sleep 1; \
              done; \
              if [ "$ready" -ne 1 ]; then echo "soffio server not ready"; [ -f "$LOG_PATH" ] && cat "$LOG_PATH"; ps -ef | grep soffio || true; kill $srv || true; exit 1; fi; \
              cargo test --target x86_64-unknown-linux-musl --test live_api -- --ignored --nocapture; \
              cargo test --target x86_64-unknown-linux-musl --test live_cache -- --ignored --nocapture; \
              kill $srv; \
              echo "=== Verifying cache observability logs ==="; \
              if ! grep -q "Cache event enqueued" "$LOG_PATH"; then \
                echo "ERROR: Missing 'Cache event enqueued' log entries"; \
                cat "$LOG_PATH"; \
                exit 1; \
              fi; \
              if ! grep -q "Cache consumption starting" "$LOG_PATH"; then \
                echo "ERROR: Missing 'Cache consumption starting' log entries"; \
                cat "$LOG_PATH"; \
                exit 1; \
              fi; \
              if ! grep -q "Cache consumption complete" "$LOG_PATH"; then \
                echo "ERROR: Missing 'Cache consumption complete' log entries"; \
                cat "$LOG_PATH"; \
                exit 1; \
              fi; \
              echo "Cache observability logs verified successfully"; \
              HOST_UID=$(stat -c '%u' /work); HOST_GID=$(stat -c '%g' /work); \
              chown -R "$HOST_UID:$HOST_GID" /work/target /root/.cargo /root/.npm || true
            '

  publish-ci-builder:
    needs: lint-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/setup-buildx-action@v3

      - name: Build & Push CI builder image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deploy/docker/Dockerfile.build
          build-args: |
            INSTALL_REDOC=true
          tags: |
            ghcr.io/${{ github.repository }}/soffio-ci-build:latest
            ghcr.io/${{ github.repository }}/soffio-ci-build:${{ github.sha }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/soffio-ci-build:buildcache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository }}/soffio-ci-build:buildcache,mode=max
          push: true
