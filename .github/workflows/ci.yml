name: CI

on:
  push:
    branches:
      - main
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Start Postgres (test DB)
        run: |
          docker run -d --name soffio-pg \
            -e POSTGRES_USER=soffio \
            -e POSTGRES_PASSWORD=soffio_local_dev \
            -e POSTGRES_DB=soffio_dev \
            -p 5432:5432 \
            postgres:18
          until docker exec soffio-pg pg_isready -U soffio -d soffio_dev; do sleep 1; done

      - name: Prepare cache directories
        run: |
          mkdir -p ~/.cargo/registry ~/.cargo/git ~/.npm

      - name: Cache cargo build
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Lint, Spec Check & Test (Alpine musl)
        run: |
          docker run --rm \
            --network=host \
            -v "${{ github.workspace }}:/work" \
            -v "$HOME/.cargo:/root/.cargo" \
            -v "$HOME/.npm:/root/.npm" \
            -w /work \
            -e DATABASE_URL=postgres://soffio:soffio_local_dev@127.0.0.1:5432/soffio_dev \
            -e SQLX_TEST_DATABASE_URL=postgres://soffio:soffio_local_dev@127.0.0.1:5432/postgres \
            -e SQLX_OFFLINE=true \
            rust:1.91-alpine3.20 \
            sh -ec '
              apk update && \
              apk add --no-cache bash binutils build-base ca-certificates clang cmake curl git libstdc++ nodejs npm pkgconf python3 && \
              rustup component add rustfmt clippy && \
              npm install --global --unsafe-perm typescript@latest @apidevtools/swagger-cli && \
              swagger-cli validate docs/api/openapi.yaml && \
              cargo fmt --all -- --check && \
              cargo check --workspace --all-targets && \
              cargo clippy --workspace --all-targets -- -D warnings && \
              cargo test --workspace --all-targets -- --nocapture && \
              cargo run --bin soffio -- import --database-url postgres://soffio:soffio_local_dev@127.0.0.1:5432/soffio_dev seed/seed.toml && \
              (cargo run --bin soffio -- serve \
                --server-host 0.0.0.0 \
                --server-admin-host 0.0.0.0 \
                --server-public-port 3000 \
                --server-admin-port 3001 \
                --config-file soffio.toml.example \
                >/tmp/soffio.log 2>&1 &) && \
              srv=$! && \
              ready=0; \
              for i in $(seq 1 60); do \
                if curl -sf http://127.0.0.1:3000/_health/db >/dev/null; then ready=1; break; fi; \
                sleep 1; \
              done && \
              if [ "$ready" -ne 1 ]; then echo "soffio server not ready" && kill $srv && exit 1; fi && \
              cargo test --test live_api -- --ignored --nocapture && \
              kill $srv
            '
